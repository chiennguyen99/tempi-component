import { t } from '../../../i18n.es.js';
import { useProp, useBuilder } from '@tempi/core-editor';
import { useState, useMemo, useEffect } from 'react';
import { FormAccountType } from '../../storage/type.es.js';
import { PROP_KEY } from '../../../constants/propKey.es.js';

var __defProp = Object.defineProperty;
var __defProps = Object.defineProperties;
var __getOwnPropDescs = Object.getOwnPropertyDescriptors;
var __getOwnPropSymbols = Object.getOwnPropertySymbols;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __propIsEnum = Object.prototype.propertyIsEnumerable;
var __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;
var __spreadValues = (a, b) => {
  for (var prop in b || (b = {}))
    if (__hasOwnProp.call(b, prop))
      __defNormalProp(a, prop, b[prop]);
  if (__getOwnPropSymbols)
    for (var prop of __getOwnPropSymbols(b)) {
      if (__propIsEnum.call(b, prop))
        __defNormalProp(a, prop, b[prop]);
    }
  return a;
};
var __spreadProps = (a, b) => __defProps(a, __getOwnPropDescs(b));
const useStorageData = (isGetFormConfigs = true) => {
  const [configStorageId, setConfigStorageId] = useProp(
    PROP_KEY.joinKey(PROP_KEY.ConfigStorage, PROP_KEY.FormConfigId)
  );
  const [configStorage, setConfigStorage] = useState();
  const { pageId, getAllFormAccounts, upsertForm, getForm } = useBuilder();
  const [ggSheetsAccounts, setGGSheetsAccounts] = useState(
    []
  );
  const [loading, setLoading] = useState(false);
  const allowConfigStorageData = useMemo(() => {
    return !!getAllFormAccounts && !!upsertForm && !!getForm;
  }, [getAllFormAccounts, getForm, upsertForm]);
  useEffect(() => {
    if (isGetFormConfigs) {
      getFormConfigs(configStorageId);
      handleFetchFormAccount();
    }
  }, []);
  const allowConfigResponseByCode = useMemo(() => {
    var _a;
    return (_a = configStorage == null ? void 0 : configStorage.configs) == null ? void 0 : _a.some(
      (item) => item.type === FormAccountType.API
    );
  }, [configStorage]);
  const getFormConfigs = async (configStorageId2, cb) => {
    try {
      let formConfig;
      setLoading(true);
      if (!!configStorageId2) {
        formConfig = await (getForm == null ? void 0 : getForm(configStorageId2));
      }
      setConfigStorage(formConfig);
      cb == null ? void 0 : cb(formConfig == null ? void 0 : formConfig.configs);
    } finally {
      setLoading(false);
    }
  };
  const handleFetchFormAccount = async (cb) => {
    const formAccounts = await (getAllFormAccounts == null ? void 0 : getAllFormAccounts());
    const newOpts = (formAccounts || []).filter((el) => el.type === "GOOGLE_SHEET").map((el) => ({
      label: el.name,
      value: el.id
    }));
    if (cb)
      cb(newOpts);
    setGGSheetsAccounts([
      ...newOpts,
      { value: -1, label: t("Th\xEAm m\u1EDBi t\xE0i kho\u1EA3n Google") }
    ]);
  };
  const handleSaveDataConfig = async (configs) => {
    try {
      setLoading(true);
      if (configs.length) {
        let mainIndex = configs.findIndex(
          (c) => c.type === FormAccountType.API
        );
        if (mainIndex < 0) {
          mainIndex = configs.findIndex(
            (c) => c.type === FormAccountType.GOOGLE_SHEET
          );
        }
        if (mainIndex < 0) {
          mainIndex = configs.findIndex(
            (c) => c.type === FormAccountType.EMAIL
          );
        }
        for (const i in configs) {
          configs[i].isMainConfig = +i === mainIndex;
        }
      }
      const idUpsert = await (upsertForm == null ? void 0 : upsertForm(__spreadProps(__spreadValues({}, configStorage || {}), {
        configs,
        pageId,
        id: configStorageId
      })));
      setConfigStorageId(idUpsert);
      getFormConfigs(idUpsert);
    } finally {
      setLoading(false);
    }
  };
  return {
    configStorage,
    setConfigStorage,
    ggSheetsAccounts,
    loading,
    handleFetchFormAccount,
    getFormConfigs,
    configStorageId,
    allowConfigStorageData,
    handleSaveDataConfig,
    allowConfigResponseByCode
  };
};

export { useStorageData };
