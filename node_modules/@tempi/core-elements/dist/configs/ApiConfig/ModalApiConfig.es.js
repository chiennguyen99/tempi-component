import { jsx, Fragment, jsxs } from 'react/jsx-runtime';
import { t } from '../../i18n.es.js';
import { MinusCircleOutlined, PlusOutlined } from '@ant-design/icons';
import styled from '@emotion/styled';
import { Form, Modal, Input, Radio, Space, Button, Tabs, Divider, Mentions, Checkbox } from 'antd';
import { useState, useRef, useEffect } from 'react';
import { RequestMethod } from '../storage/type.es.js';
import { isJsonString } from '../../utils/isJsonString.es.js';

var __defProp = Object.defineProperty;
var __defProps = Object.defineProperties;
var __getOwnPropDescs = Object.getOwnPropertyDescriptors;
var __getOwnPropSymbols = Object.getOwnPropertySymbols;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __propIsEnum = Object.prototype.propertyIsEnumerable;
var __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;
var __spreadValues = (a, b) => {
  for (var prop in b || (b = {}))
    if (__hasOwnProp.call(b, prop))
      __defNormalProp(a, prop, b[prop]);
  if (__getOwnPropSymbols)
    for (var prop of __getOwnPropSymbols(b)) {
      if (__propIsEnum.call(b, prop))
        __defNormalProp(a, prop, b[prop]);
    }
  return a;
};
var __spreadProps = (a, b) => __defProps(a, __getOwnPropDescs(b));
var __objRest = (source, exclude) => {
  var target = {};
  for (var prop in source)
    if (__hasOwnProp.call(source, prop) && exclude.indexOf(prop) < 0)
      target[prop] = source[prop];
  if (source != null && __getOwnPropSymbols)
    for (var prop of __getOwnPropSymbols(source)) {
      if (exclude.indexOf(prop) < 0 && __propIsEnum.call(source, prop))
        target[prop] = source[prop];
    }
  return target;
};
const defaultMethod = [
  {
    label: "GET",
    value: RequestMethod.GET
  },
  {
    label: "POST",
    value: RequestMethod.POST
  },
  {
    label: "PUT",
    value: RequestMethod.PUT
  },
  {
    label: "PATCH",
    value: RequestMethod.PATCH
  },
  {
    label: "DELETE",
    value: RequestMethod.DELETE
  }
];
const ModalApiConfig = ({
  onSubmit,
  isModalOpen,
  title = t("Li\xEAn k\u1EBFt API"),
  data,
  closeModal,
  closable = true,
  config = {
    testApi: true
  },
  optionMethods = defaultMethod,
  attributes = [],
  getContainer
}) => {
  const [loading, setLoading] = useState(false);
  const [testResponse, setTestResponse] = useState();
  const [form] = Form.useForm();
  const [bodyType, setBodyType] = useState("application/json" /* JSON */);
  const mentionRef = useRef(null);
  const defaultValue = {
    endpoint: "",
    method: RequestMethod.GET
  };
  const listToObject = (list) => {
    if (!list)
      return;
    const object = {};
    for (let i = 0; i < list.length; i++) {
      if (list[i]) {
        const { key, value } = list[i];
        if (key && value)
          object[key] = value;
      }
    }
    return object;
  };
  const objectToList = (obj) => {
    if (!obj)
      return;
    const list = [];
    Object.keys(obj).forEach((key) => {
      list.push({ key, value: obj[key].toString() });
    });
    return list;
  };
  const formatFormValues = (values) => {
    const request = __spreadValues(__spreadValues({
      endpoint: values.endpoint,
      method: values.method
    }, values.isMainConfig !== void 0 && {
      isMainConfig: values.isMainConfig
    }), values.name !== void 0 && { name: values.name });
    if (values.method !== RequestMethod.GET) {
      request.headers = {};
      request.headers["Content-Type"] = bodyType;
    }
    if (values.headers) {
      request.headers = __spreadValues(__spreadValues({}, request.headers), listToObject(values.headers));
    }
    if (values.body) {
      if (bodyType === "application/x-www-form-urlencoded" /* URL_ENCODED */) {
        request.body = listToObject(values.body);
      } else {
        request.body = JSON.parse(values.body);
      }
    }
    return request;
  };
  useEffect(() => {
    var _a;
    if (isModalOpen) {
      if (!!data) {
        form.setFieldsValue({
          endpoint: data.endpoint,
          method: data.method,
          headers: objectToList(data.headers),
          body: typeof data.body === "object" ? ((_a = data.headers) == null ? void 0 : _a["content-Type"]) == "application/x-www-form-urlencoded" /* URL_ENCODED */ ? objectToList(data.body) : JSON.stringify(data.body) : data.body,
          isMainConfig: data == null ? void 0 : data.isMainConfig,
          name: data == null ? void 0 : data.name
        });
      } else {
        form.setFieldsValue(defaultValue);
      }
    } else {
      setTestResponse(null);
    }
  }, [isModalOpen]);
  return /* @__PURE__ */ jsx(Fragment, {
    children: /* @__PURE__ */ jsxs(Modal, {
      zIndex: 2001,
      title,
      open: isModalOpen,
      onOk: () => form.submit(),
      okText: t("L\u01B0u"),
      okButtonProps: { loading, disabled: loading },
      cancelText: t("common.cancel"),
      onCancel: () => {
        closeModal();
      },
      destroyOnClose: true,
      maskClosable: false,
      closable,
      className: "api-config-modal",
      getContainer,
      children: [
        /* @__PURE__ */ jsxs(Form, {
          form,
          onFinish: async (values) => {
            setLoading(true);
            await onSubmit(formatFormValues(values));
            setLoading(false);
            closeModal();
          },
          layout: "vertical",
          children: [
            (config == null ? void 0 : config.name) && /* @__PURE__ */ jsx(Form.Item, {
              name: "name",
              label: t("T\xEAn g\u1EE3i nh\u1EDB"),
              children: /* @__PURE__ */ jsx(Input, {
                placeholder: t("Nh\u1EADp t\xEAn"),
                autoComplete: "off"
              })
            }),
            /* @__PURE__ */ jsx(StyledLabel, {
              children: t("C\u1EA5u h\xECnh API")
            }),
            /* @__PURE__ */ jsx(Form.Item, {
              name: "method",
              rules: [
                {
                  required: true,
                  message: t("Tr\u01B0\u1EDDng n\xE0y l\xE0 b\u1EAFt bu\u1ED9c")
                }
              ],
              children: /* @__PURE__ */ jsx(Radio.Group, {
                options: optionMethods
              })
            }),
            /* @__PURE__ */ jsx(Form.Item, {
              name: "endpoint",
              rules: [
                {
                  required: true,
                  message: t("Tr\u01B0\u1EDDng n\xE0y l\xE0 b\u1EAFt bu\u1ED9c")
                }
              ],
              children: /* @__PURE__ */ jsx(Input, {
                placeholder: t("Nh\u1EADp URL")
              })
            }),
            /* @__PURE__ */ jsx(StyledLabel, {
              children: "Headers"
            }),
            /* @__PURE__ */ jsx(Form.List, {
              name: "headers",
              children: (fields, { add, remove }) => /* @__PURE__ */ jsxs(Fragment, {
                children: [
                  fields.map((_a) => {
                    var _b = _a, { key, name } = _b, restField = __objRest(_b, ["key", "name"]);
                    return /* @__PURE__ */ jsxs(Space, {
                      style: { display: "flex" },
                      align: "baseline",
                      children: [
                        /* @__PURE__ */ jsx(Form.Item, __spreadProps(__spreadValues({}, restField), {
                          name: [name, "key"],
                          rules: [
                            { required: true, message: t("Thi\u1EBFu tr\u01B0\u1EDDng key") }
                          ],
                          children: /* @__PURE__ */ jsx(Input, {
                            placeholder: "Key"
                          })
                        })),
                        /* @__PURE__ */ jsx(Form.Item, __spreadProps(__spreadValues({}, restField), {
                          name: [name, "value"],
                          rules: [
                            { required: true, message: t("Thi\u1EBFu tr\u01B0\u1EDDng value") }
                          ],
                          children: /* @__PURE__ */ jsx(Input, {
                            placeholder: "Value"
                          })
                        })),
                        /* @__PURE__ */ jsx(MinusCircleOutlined, {
                          onClick: () => remove(name),
                          style: {
                            fontSize: "1.2em",
                            cursor: "pointer"
                          }
                        })
                      ]
                    }, key);
                  }),
                  /* @__PURE__ */ jsx(Form.Item, {
                    children: /* @__PURE__ */ jsx(Button, {
                      type: "dashed",
                      icon: /* @__PURE__ */ jsx(PlusOutlined, {}),
                      onClick: () => add(),
                      children: t("Th\xEAm Header")
                    })
                  })
                ]
              })
            }),
            /* @__PURE__ */ jsx(Form.Item, {
              noStyle: true,
              shouldUpdate: (prev, cur) => prev.method !== cur.method || prev.body !== cur.body,
              children: ({ getFieldValue }) => getFieldValue("method") !== RequestMethod.GET && /* @__PURE__ */ jsxs(Fragment, {
                children: [
                  /* @__PURE__ */ jsx(StyledLabel, {
                    children: "Send"
                  }),
                  /* @__PURE__ */ jsxs(StyledTabs, {
                    onChange: (key) => {
                      setBodyType(key);
                      form.resetFields(["body"]);
                    },
                    children: [
                      /* @__PURE__ */ jsxs(Tabs.TabPane, {
                        tab: "JSON",
                        children: [
                          /* @__PURE__ */ jsx("div", {
                            ref: mentionRef,
                            children: /* @__PURE__ */ jsx(Form.Item, {
                              name: "body",
                              rules: [
                                {
                                  validator: (_, value) => {
                                    if (bodyType !== "application/json" /* JSON */) {
                                      return Promise.resolve();
                                    }
                                    if (value && value.length > 0) {
                                      if (isJsonString(value)) {
                                        return Promise.resolve();
                                      } else {
                                        return Promise.reject(
                                          new Error(
                                            t("Kh\xF4ng \u0111\xFAng \u0111\u1ECBnh d\u1EA1ng JSON!")
                                          )
                                        );
                                      }
                                    } else {
                                      return Promise.resolve();
                                    }
                                  }
                                }
                              ],
                              children: /* @__PURE__ */ jsx(StyledMentions, {
                                prefix: ["{{"],
                                onSearch: () => {
                                },
                                rows: 5,
                                onChange: (text) => form.setFieldsValue({ body: text }),
                                getPopupContainer: () => {
                                  var _a;
                                  return (_a = mentionRef == null ? void 0 : mentionRef.current) == null ? void 0 : _a.getElementsByClassName(
                                    "ant-mentions"
                                  )[0];
                                },
                                options: attributes.map((att) => ({
                                  label: att,
                                  value: `${att}}}`
                                }))
                              })
                            })
                          }),
                          /* @__PURE__ */ jsxs("div", {
                            style: { color: "#A7ABC3", margin: "5px 0 10px 0" },
                            children: [
                              t("B\u1EA1n c\xF3 th\u1EC3 th\xEAm tr\u01B0\u1EDDng c\xF3 s\u1EB5n v\u1EDBi"),
                              `{{...}}`
                            ]
                          })
                        ]
                      }, "application/json" /* JSON */),
                      /* @__PURE__ */ jsx(Tabs.TabPane, {
                        tab: "URL encoded",
                        children: /* @__PURE__ */ jsx(Form.List, {
                          name: "body",
                          children: (fields, { add, remove }) => /* @__PURE__ */ jsxs(Fragment, {
                            children: [
                              fields.map((_a) => {
                                var _b = _a, { key, name } = _b, restField = __objRest(_b, ["key", "name"]);
                                return /* @__PURE__ */ jsxs(Space, {
                                  style: { display: "flex" },
                                  align: "baseline",
                                  children: [
                                    /* @__PURE__ */ jsx(Form.Item, __spreadProps(__spreadValues({}, restField), {
                                      name: [name, "key"],
                                      rules: [
                                        {
                                          required: true,
                                          message: t("Thi\u1EBFu tr\u01B0\u1EDDng title")
                                        }
                                      ],
                                      children: /* @__PURE__ */ jsx(Input, {
                                        placeholder: "Title"
                                      })
                                    })),
                                    /* @__PURE__ */ jsx(Form.Item, __spreadProps(__spreadValues({}, restField), {
                                      name: [name, "value"],
                                      rules: [
                                        {
                                          required: true,
                                          message: t("Thi\u1EBFu tr\u01B0\u1EDDng value")
                                        }
                                      ],
                                      children: /* @__PURE__ */ jsx(Input, {
                                        placeholder: "Value"
                                      })
                                    })),
                                    /* @__PURE__ */ jsx(MinusCircleOutlined, {
                                      onClick: () => remove(name),
                                      style: {
                                        color: "white",
                                        fontSize: "1.2em",
                                        cursor: "pointer"
                                      }
                                    })
                                  ]
                                }, key);
                              }),
                              /* @__PURE__ */ jsx(Form.Item, {
                                children: /* @__PURE__ */ jsx(Button, {
                                  type: "text",
                                  onClick: () => add(),
                                  icon: /* @__PURE__ */ jsx(PlusOutlined, {
                                    style: {
                                      marginRight: "0.2em",
                                      fontSize: "1.2em"
                                    }
                                  }),
                                  children: t("Th\xEAm tham s\u1ED1")
                                })
                              })
                            ]
                          })
                        })
                      }, "application/x-www-form-urlencoded" /* URL_ENCODED */)
                    ]
                  })
                ]
              })
            }),
            (config == null ? void 0 : config.checkboxMainConfig) && /* @__PURE__ */ jsx(Form.Item, {
              valuePropName: "checked",
              name: "isMainConfig",
              children: /* @__PURE__ */ jsx(StyledCheckbox, {
                children: t("\u0110\u1EB7t l\xE0m k\u1EBFt n\u1ED1i ch\xEDnh")
              })
            })
          ]
        }),
        testResponse && /* @__PURE__ */ jsxs(Fragment, {
          children: [
            /* @__PURE__ */ jsx(Divider, {}),
            /* @__PURE__ */ jsxs("div", {
              style: {
                display: "flex",
                justifyContent: "space-between",
                alignItems: "center",
                color: "white"
              },
              children: [
                /* @__PURE__ */ jsx(StyledLabel, {
                  children: "Response"
                }),
                /* @__PURE__ */ jsx("span", {
                  children: testResponse == null ? void 0 : testResponse.responseCode
                })
              ]
            }),
            /* @__PURE__ */ jsxs(StyledVerticalTabs, {
              tabPosition: "left",
              defaultActiveKey: "response-body",
              children: [
                /* @__PURE__ */ jsx(Tabs.TabPane, {
                  tab: "Response headers",
                  children: /* @__PURE__ */ jsx(Input.TextArea, {
                    value: JSON.stringify(testResponse == null ? void 0 : testResponse.responseHeaders),
                    rows: 8,
                    disabled: true
                  })
                }, "response-headers"),
                /* @__PURE__ */ jsx(Tabs.TabPane, {
                  tab: "Response body",
                  children: /* @__PURE__ */ jsx(StyledTextArea, {
                    value: JSON.stringify(testResponse == null ? void 0 : testResponse.response),
                    rows: 8,
                    disabled: true
                  })
                }, "response-body")
              ]
            })
          ]
        })
      ]
    })
  });
};
const StyledTextArea = styled(Input.TextArea)`
  cursor: text !important;
`;
const StyledLabel = styled.div`
  font-weight: 500;
  margin: 1em 0 0.5em 0;
  font-size: 13px;
`;
const StyledTabs = styled(Tabs)`
  .ant-tabs-tab-btn {
    transition: none;
  }
`;
const StyledVerticalTabs = styled(Tabs)(
  ({ theme }) => `
  .ant-tabs-tab {
    color: #82869e;
    padding: 0 20px 0 0 !important;
  }
  .ant-tabs-tab-active .ant-tabs-tab-btn {
    color: ${theme.colorPrimary} !important;
  }
`
);
const StyledMentions = styled(Mentions)`
  z-index: 9999;
  overflow: visible;
`;
const StyledCheckbox = styled(Checkbox)`
  margin-top: 24px;
`;

export { ModalApiConfig };
