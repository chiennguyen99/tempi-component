import { jsx } from 'react/jsx-runtime';
import styled from '@emotion/styled';
import { generateRandomId, getStyle } from '@tempi/core-renderer';
import { forwardRef, useState, useRef, useMemo, useEffect } from 'react';
import { createPortal } from 'react-dom';
import { DEFAULT_POLLING_INLINE_INTERVAL, DEFAULT_INLINE_BANNER } from './constants.es.js';
import { InlineBannerRelativePosition } from './type.es.js';
import { Link } from '../../core/Link/index.es.js';

var __defProp = Object.defineProperty;
var __defProps = Object.defineProperties;
var __getOwnPropDescs = Object.getOwnPropertyDescriptors;
var __getOwnPropSymbols = Object.getOwnPropertySymbols;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __propIsEnum = Object.prototype.propertyIsEnumerable;
var __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;
var __spreadValues = (a, b) => {
  for (var prop in b || (b = {}))
    if (__hasOwnProp.call(b, prop))
      __defNormalProp(a, prop, b[prop]);
  if (__getOwnPropSymbols)
    for (var prop of __getOwnPropSymbols(b)) {
      if (__propIsEnum.call(b, prop))
        __defNormalProp(a, prop, b[prop]);
    }
  return a;
};
var __spreadProps = (a, b) => __defProps(a, __getOwnPropDescs(b));
var __objRest = (source, exclude) => {
  var target = {};
  for (var prop in source)
    if (__hasOwnProp.call(source, prop) && exclude.indexOf(prop) < 0)
      target[prop] = source[prop];
  if (source != null && __getOwnPropSymbols)
    for (var prop of __getOwnPropSymbols(source)) {
      if (exclude.indexOf(prop) < 0 && __propIsEnum.call(source, prop))
        target[prop] = source[prop];
    }
  return target;
};
const InlineBanner = forwardRef(
  (_a, ref) => {
    var _b = _a, {
      commonStyle,
      children,
      isEditorMode,
      cssSelector,
      customCss,
      relativePosition = InlineBannerRelativePosition.BEFORE,
      event,
      pollingInterval = DEFAULT_POLLING_INLINE_INTERVAL
    } = _b, rest = __objRest(_b, [
      "commonStyle",
      "children",
      "isEditorMode",
      "cssSelector",
      "customCss",
      "relativePosition",
      "event",
      "pollingInterval"
    ]);
    const [mountedDomElement, setMountedDomElement] = useState();
    const mountElementIdRef = useRef();
    const defaultCommonStyle = useMemo(
      () => __spreadValues(__spreadValues({}, DEFAULT_INLINE_BANNER.commonStyle), commonStyle),
      [commonStyle]
    );
    const renderInlineBanner = () => {
      return /* @__PURE__ */ jsx(Wrapper, __spreadProps(__spreadValues({
        commonStyle: defaultCommonStyle,
        customCss,
        ref
      }, rest), {
        children
      }));
    };
    useEffect(() => {
      const baseElementPollingInterval = setInterval(() => {
        if (cssSelector) {
          try {
            const baseElement = document.querySelector(cssSelector);
            if (baseElement && !mountElementIdRef.current) {
              clearInterval(baseElementPollingInterval);
              const mountElement = document.createElement("div");
              const mountElementUniqueId = generateRandomId(10);
              mountElement.id = mountElementUniqueId;
              mountElementIdRef.current = mountElementUniqueId;
              switch (relativePosition) {
                case InlineBannerRelativePosition.BEFORE:
                  baseElement.before(mountElement);
                  break;
                case InlineBannerRelativePosition.AFTER:
                  baseElement.after(mountElement);
                  break;
                case InlineBannerRelativePosition.IN:
                  baseElement.appendChild(mountElement);
                  break;
              }
              setMountedDomElement(mountElement);
            }
          } catch (e) {
            console.warn("Invalid css selector provided for InlineBanner", e);
          }
        }
      }, pollingInterval);
      return () => {
        clearInterval(baseElementPollingInterval);
      };
    }, [cssSelector, relativePosition, pollingInterval]);
    if (isEditorMode) {
      return renderInlineBanner();
    }
    if (mountedDomElement) {
      return createPortal(
        /* @__PURE__ */ jsx(Link, __spreadProps(__spreadValues({}, event), {
          children: renderInlineBanner()
        })),
        mountedDomElement
      );
    }
    return null;
  }
);
const Wrapper = styled.div(
  ({ commonStyle, customCss }) => `
  ${getStyle(commonStyle)}
  ${customCss != null ? customCss : ""}
`
);
InlineBanner.displayName = "InlineBanner";

export { InlineBanner };
