import { jsx, jsxs, Fragment } from 'react/jsx-runtime';
import { t } from '../../../../i18n.es.js';
import { SortableContext, verticalListSortingStrategy, arrayMove } from '@dnd-kit/sortable';
import { usePropSeparateDevice, ImageUploadButton, beforeUploadImage, UploadImageButton, EditableRow, EditableCell } from '@tempi/core-editor';
import { Tooltip, Typography, Modal, Button, Table } from 'antd';
import { useState, useEffect } from 'react';
import { DndContext } from '@dnd-kit/core';
import { v4 } from 'uuid';
import { useFrame } from 'react-frame-component';
import set from 'lodash.set';
import get from 'lodash.get';
import { DEFAULT_PRODUCT } from '../../constants.es.js';
import { RatingConfig } from '../../../../configs/RatingConfig/RatingConfig.es.js';
import { PROP_KEY } from '../../../../constants/propKey.es.js';

var __defProp = Object.defineProperty;
var __defProps = Object.defineProperties;
var __getOwnPropDescs = Object.getOwnPropertyDescriptors;
var __getOwnPropSymbols = Object.getOwnPropertySymbols;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __propIsEnum = Object.prototype.propertyIsEnumerable;
var __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;
var __spreadValues = (a, b) => {
  for (var prop in b || (b = {}))
    if (__hasOwnProp.call(b, prop))
      __defNormalProp(a, prop, b[prop]);
  if (__getOwnPropSymbols)
    for (var prop of __getOwnPropSymbols(b)) {
      if (__propIsEnum.call(b, prop))
        __defNormalProp(a, prop, b[prop]);
    }
  return a;
};
var __spreadProps = (a, b) => __defProps(a, __getOwnPropDescs(b));
var __objRest = (source, exclude) => {
  var target = {};
  for (var prop in source)
    if (__hasOwnProp.call(source, prop) && exclude.indexOf(prop) < 0)
      target[prop] = source[prop];
  if (source != null && __getOwnPropSymbols)
    for (var prop of __getOwnPropSymbols(source)) {
      if (exclude.indexOf(prop) < 0 && __propIsEnum.call(source, prop))
        target[prop] = source[prop];
    }
  return target;
};
const ProductListConfigModal = ({
  visible,
  setVisible,
  separateDevice
}) => {
  const { document: frameDocument } = useFrame();
  const itemsPropKey = PROP_KEY.Items;
  const [items, setItems] = usePropSeparateDevice(itemsPropKey, false, {
    formatter: (val) => {
      var _a, _b;
      return (_b = (_a = val || []).map) == null ? void 0 : _b.call(_a, (el) => __spreadProps(__spreadValues({}, el), {
        id: el.id ? el.id : v4()
      }));
    }
  });
  const [modalState, setModalState] = useState([]);
  const [eventType] = usePropSeparateDevice(PROP_KEY.EventType, separateDevice);
  const handleChangeValueOnRow = (index, key, newValue) => {
    const dataPropKey = PROP_KEY.joinKey(index + "", key);
    setModalState((prev) => {
      const newState = JSON.parse(JSON.stringify(prev));
      set(newState, dataPropKey, newValue);
      return newState;
    });
  };
  const getValueOnRow = (index, key) => {
    const dataPropKey = PROP_KEY.joinKey(index + "", key);
    return get(modalState, dataPropKey);
  };
  const onAddItem = () => {
    const cloneItems = [...modalState];
    const newProduct = {
      id: v4(),
      name: t("S\u1EA3n ph\u1EA9m m\u1EDBi"),
      price: 1e5,
      discount: 20,
      virtualRating: 5
    };
    cloneItems.unshift(newProduct);
    setModalState(cloneItems);
  };
  const onDuplicateItem = (index) => {
    const cloneItems = [...modalState];
    const newRecord = __spreadProps(__spreadValues({}, cloneItems[index]), {
      id: v4()
    });
    cloneItems.splice(index + 1, 0, newRecord);
    setModalState(cloneItems);
  };
  const onDeleteItem = (index) => {
    const cloneItems = [...modalState];
    cloneItems.splice(index, 1);
    setModalState(cloneItems);
  };
  const onChangeRow = (rowIndex, dataIndex, value) => {
    if (value === modalState[rowIndex][dataIndex])
      return;
    handleChangeValueOnRow(rowIndex, dataIndex, value);
  };
  const defaultColumns = [
    {
      key: "sort",
      width: 55,
      fixed: "left"
    },
    {
      title: t("common.image"),
      dataIndex: "image",
      key: "image",
      width: 150,
      render: (_text, _record, index) => {
        const imagePropKey = PROP_KEY.joinKey(
          itemsPropKey,
          index + "",
          PROP_KEY.Image,
          PROP_KEY.Src
        );
        const widthPropKey = PROP_KEY.joinKey(
          itemsPropKey,
          index + "",
          PROP_KEY.Image,
          PROP_KEY.GoogleImageParams,
          PROP_KEY.Width
        );
        return /* @__PURE__ */ jsx(ImageUploadButton, {
          accept: "image/jpg, image/jpeg, image/png, image/gif, image/webp",
          beforeUpload: beforeUploadImage,
          imagePropKey,
          widthPropKey,
          separateDevice,
          layout: "vertical",
          stateImageUpload: {
            image: getValueOnRow(
              index,
              PROP_KEY.joinKey(PROP_KEY.Image, PROP_KEY.Src)
            ),
            setImage: (v) => handleChangeValueOnRow(
              index,
              PROP_KEY.joinKey(PROP_KEY.Image, PROP_KEY.Src),
              v
            ),
            setWidth: (v) => handleChangeValueOnRow(
              index,
              PROP_KEY.joinKey(
                PROP_KEY.Image,
                PROP_KEY.GoogleImageParams,
                PROP_KEY.Width
              ),
              v
            )
          }
        });
      },
      fixed: "left"
    },
    {
      title: t("T\xEAn s\u1EA3n ph\u1EA9m"),
      dataIndex: "name",
      key: "name",
      editable: {
        inputType: "text",
        rules: [
          {
            required: true,
            message: t("B\u1EA1n ch\u01B0a c\u1EA5u h\xECnh t\xEAn s\u1EA3n ph\u1EA9m")
          }
        ]
      },
      width: 250,
      ellipsis: true
    },
    {
      title: t("Gi\xE1 b\xE1n"),
      dataIndex: "price",
      key: "price",
      editable: {
        inputType: "number",
        rules: [
          {
            type: "number",
            min: 0,
            message: t("Gi\xE1 b\xE1n kh\xF4ng \u0111\u01B0\u1EE3c nh\u1ECF h\u01A1n 0")
          }
        ]
      },
      width: 200,
      ellipsis: true
    },
    {
      title: t("% gi\u1EA3m gi\xE1"),
      dataIndex: "discount",
      key: "discount",
      editable: {
        inputType: "number",
        rules: [
          {
            type: "number",
            min: 0,
            message: t("C\u1EA7n n\u1EB1m trong kho\u1EA3ng 0 \u0111\u1EBFn 100")
          },
          {
            type: "number",
            max: 100,
            message: t("C\u1EA7n n\u1EB1m trong kho\u1EA3ng 0 \u0111\u1EBFn 100")
          }
        ]
      },
      width: 120,
      ellipsis: true
    },
    {
      title: t("\u0110\xE1nh gi\xE1 \u1EA3o"),
      dataIndex: PROP_KEY.VirtualRating,
      key: PROP_KEY.VirtualRating,
      width: 150,
      render: (_text, _record, index) => {
        const propKey = PROP_KEY.joinKey(
          itemsPropKey,
          index + "",
          PROP_KEY.VirtualRating
        );
        return /* @__PURE__ */ jsx(RatingConfig, {
          propKey,
          ratingProps: {
            value: getValueOnRow(index, PROP_KEY.VirtualRating),
            onChange: (v) => handleChangeValueOnRow(index, PROP_KEY.VirtualRating, v)
          }
        });
      }
    },
    {
      title: t("L\u01B0\u1EE3t mua \u1EA3o"),
      dataIndex: PROP_KEY.VirtualSold,
      key: PROP_KEY.VirtualSold,
      editable: {
        inputType: "number",
        rules: [
          {
            type: "number",
            min: 0,
            message: t("L\u01B0\u1EE3t mua \u1EA3o c\u1EA7n l\u1EDBn h\u01A1n 0")
          }
        ]
      },
      width: 120,
      ellipsis: true
    },
    {
      title: () => /* @__PURE__ */ jsx(Tooltip, {
        zIndex: 1081,
        placement: "bottomRight",
        title: t("\u0110i\u1EC1u h\u01B0\u1EDBng \u0111\u1EBFn khi kh\xE1ch h\xE0ng b\u1EA5m v\xE0o s\u1EA3n ph\u1EA9m"),
        children: t("\u0110\u01B0\u1EDDng d\u1EABn (n\u1EBFu c\xF3)")
      }),
      dataIndex: "link",
      key: "link",
      editable: {
        inputType: "text",
        rules: [
          {
            required: eventType === "link",
            message: t("Vui l\xF2ng nh\u1EADp \u0111\u01B0\u1EDDng d\u1EABn")
          }
        ]
      },
      width: 200,
      ellipsis: true
    },
    {
      title: t("H\xE0nh \u0111\u1ED9ng"),
      key: "action",
      dataIndex: "action",
      fixed: "right",
      width: 150,
      render: (_, _record, index) => {
        return /* @__PURE__ */ jsxs("div", {
          children: [
            /* @__PURE__ */ jsx(Typography.Link, {
              className: "mr-half",
              onClick: () => onDuplicateItem(index),
              children: t("Nh\xE2n b\u1EA3n")
            }),
            /* @__PURE__ */ jsx(Typography.Link, {
              onClick: () => onDeleteItem(index),
              children: t("Xo\xE1")
            })
          ]
        });
      }
    }
  ];
  const columns = defaultColumns.map((col) => {
    if (!col.editable) {
      return col;
    }
    return __spreadProps(__spreadValues({}, col), {
      onCell: (record, rowIndex) => ({
        editable: col.editable,
        dataIndex: col.dataIndex,
        title: col.title,
        rowIndex,
        propKey: itemsPropKey,
        separateDevice,
        record,
        onChange: (value) => onChangeRow(rowIndex, col.dataIndex, value)
      })
    });
  });
  const components = {
    body: {
      row: EditableRow,
      cell: EditableCell
    }
  };
  const onDragEnd = ({ active, over }) => {
    if ((active == null ? void 0 : active.id) !== (over == null ? void 0 : over.id)) {
      let cloneItems = [...modalState];
      const activeIndex = cloneItems.findIndex((i) => i.id === (active == null ? void 0 : active.id));
      const overIndex = cloneItems.findIndex((i) => i.id === (over == null ? void 0 : over.id));
      cloneItems = arrayMove(cloneItems, activeIndex, overIndex);
      setModalState(cloneItems);
    }
  };
  const onClose = () => setVisible(false);
  const addProduct = (imageUrls) => {
    if (!(imageUrls == null ? void 0 : imageUrls.length))
      return;
    const newItems = [];
    imageUrls.forEach((url) => {
      const newObject = {
        src: url,
        googleImageParams: {
          width: 0
        }
      };
      newItems.push(__spreadProps(__spreadValues({}, DEFAULT_PRODUCT), {
        id: v4(),
        image: newObject
      }));
    });
    setModalState((prev) => {
      return [...newItems, ...prev];
    });
  };
  const handleClose = () => {
    setItems(
      modalState.map((el) => {
        const _a = el, rest = __objRest(_a, ["id"]);
        return rest;
      })
    );
    onClose == null ? void 0 : onClose();
  };
  useEffect(() => {
    if (visible)
      setModalState(items);
  }, [visible]);
  return /* @__PURE__ */ jsxs(Modal, {
    bodyStyle: {
      minHeight: 500
    },
    style: {
      top: 20
    },
    zIndex: 1080,
    width: "100%",
    title: t("Qu\u1EA3n l\xFD s\u1EA3n ph\u1EA9m"),
    okText: t("\u0110\xF3ng"),
    destroyOnClose: true,
    onCancel: handleClose,
    open: visible,
    getContainer: () => (frameDocument == null ? void 0 : frameDocument.body) || (document == null ? void 0 : document.body),
    footer: /* @__PURE__ */ jsx(Fragment, {
      children: /* @__PURE__ */ jsx(Button, {
        type: "primary",
        onClick: handleClose,
        shape: "round",
        children: t("\u0110\xF3ng")
      })
    }),
    children: [
      /* @__PURE__ */ jsxs("div", {
        className: "my-base",
        style: { display: "flex", justifyContent: "flex-end", gap: 8 },
        children: [
          /* @__PURE__ */ jsx(UploadImageButton, {
            handlerAfterUpload: addProduct
          }),
          /* @__PURE__ */ jsx(Button, {
            type: "primary",
            shape: "round",
            onClick: onAddItem,
            children: t("Th\xEAm m\u1EDBi s\u1EA3n ph\u1EA9m")
          })
        ]
      }),
      /* @__PURE__ */ jsx(DndContext, {
        onDragEnd,
        children: /* @__PURE__ */ jsx(SortableContext, {
          items: modalState == null ? void 0 : modalState.map((i) => i.id),
          strategy: verticalListSortingStrategy,
          children: /* @__PURE__ */ jsx(Table, {
            components,
            dataSource: modalState,
            rowKey: "id",
            columns,
            pagination: false,
            scroll: { x: 1e3, y: 500 }
          })
        })
      })
    ]
  });
};

export { ProductListConfigModal };
